#!/bin/sh

[ -f     .scc ]  && .     .scc
[ -f   ~/.scc ]  && .   ~/.scc
[ -f /etc/scc ]  && . /etc/scc

CXXFLAGS+=" -Wall -std=gnu++0x  -pipe -O0 -Wno-sign-compare"
FILE=$(find $0  -printf '%l\n')
SCC_HOME="$(dirname ${FILE:-$0})"
CXXFLAGS+=" -I $SCC_HOME "

prg=/tmp/$USER-scc
src=$prg.cc

usage_exit() {
	echo "
	USAGE:  scc [options]  snippets [args] 
		
		-n 	- for each line: read; split into fields; execute snippet 
		-p 	- for each line: read; split into fields; execute snippet;  output fields
		-B	- do not use Boost
		-v 	- vebose
	"
	exit 0
}

####################################################################################### OPTIONS 

while getopts npvB opt;  do
	case $opt in
		n)	n_opt=1;  is_stream=1;;
		p)	p_opt=1;  is_stream=1;;
		B)	no_boost=1;;
		v)	verbose=1;;
		?) 	usage_exit;;

	esac
done


shift $((OPTIND-1))

[[  $1 ]] || usage_exit


[[ ! -d /usr/include/boost  ]]  &&  no_boost=1

#####################################################################################  PARSE SNIPPET
#echo -e ' A;\n B; A\n A\n B; A\n {}A\n B({A})\n'|tee /dev/tty|   sed 's/\({[^}]*}\)\{0\}\(\(\((.*)\)\|[^;]\)\+$\)/cout << ( \2 );/'
#echo "$@" | sed 's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 );/' >> $src


end_prt="`echo \"$1\" | sed -n 's/\(.*[;}]\)*\([^;}]\+$\)/1/p'`"

if [[ $verbose ]] ; then 
	echo -n "$1                                 "
	echo -n `(gcc -v  2>&1) | sed -n '/^gcc version/s/^gcc version \([.0-9]*\) .*/\1/p'`
	echo "   no_boost: $no_boost;   n_opt: $n_opt;   p_opt: $p_opt;   is_stream: $is_stream;   end_prt: $end_prt"
	#echo "CXXFLAGS:  $CXXFLAGS"
fi 

snippet="`echo \"$1\" | sed    's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 );/'`"

[[ $n_opt       && $end_prt ]]	&& snippet+="cout << endl;"
[[ ! $is_stream && $end_prt ]]	&& snippet+="cout << endl;"

shift

#####################################################################################  GENERATE SRC

cat <<  END	 > $src
#include <simple.h>
#ifdef MODERN_GCC 
#include <scc.h>
#endif

	int main(int argc, char** argv) {
END

if [[  $is_stream ]];  then 

	echo " while ( read_line()) { $snippet " >> $src

	if [[  $p_opt ]];  then 

		[[ $end_prt ]]   &&  echo 'cout << OFS;' >> $src

		echo "
			for(int i=0;   i < int(F.size())-1;  i++)
				cout  << F[i] << OFS;
			if (F.size() > 0)  cout << F.back();
			cout << endl;
		" >> $src
	fi

	echo "}" >> $src

else
	echo "$snippet" >> $src  
fi


echo '}' >>  $src


if [[ ! $no_boost ]];  then 
	LIBS+='-lboost_regex'
	CXXFLAGS+=" -DUSE_BOOST "
fi 

			#echo "-------------------------------------------------"
			#echo is_stream: $is_stream
			#echo p_opt: $p_opt
			#echo no_boost: $no_boost
			#echo snippet: $snippet
			#echo end_prt: $end_prt

${CXX-g++} $CXXFLAGS $prg.cc -o $prg $LIBS && $prg "$@"

# vim:set ts=8 sw=8 syntax=sh:   
