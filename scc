#!/bin/sh


[ -f     .scc ]  && .     .scc
[ -f   ~/.scc ]  && .   ~/.scc
[ -f /etc/scc ]  && . /etc/scc

CXXFLAGS+=" -Wall -std=gnu++0x  -ggdb3 -O0 -Wno-sign-compare"
FILE=$(find $0  -printf '%l\n')
SCC_HOME="$(dirname ${FILE:-$0})"
CXXFLAGS+=" -I $SCC_HOME "

if [ -d /usr/include/boost ];  then 
	LIBS+='-lboost_regex'
	CXXFLAGS+=" -DUSE_BOOST "
fi 

prg=/tmp/$USER-scc
src=$prg.cc
: ${1? Usage: css [options] 'c++ snippet' [arg...] }

cat <<  END	 > $src
	#include <simple.h>
	using namespace std;

	struct   F_t : deque<str> {
		str& 	operator()(size_t I) {
			this->resize(I+1);
			return (*this)[I];
		};
	};

	std::ostream&   operator<<      (ostream& os, const vector<str, std::allocator<str> >& C) {              
		cout << "{";
		auto it=C.begin();
		for (int i=0;   i < int(C.size())-1;   i++, it++)	os  << *it <<  ", ";
		if (!C.empty())  					os  << *it;
		cout << "}";
		return os;
	};

	F_t F;
	int NF = 0;
	int NR = -1;

	string	 __attribute__((unused))	line;
	char 	 __attribute__((unused))	IFS=' ';
	string	 __attribute__((unused))	OFS(" ");


	void	split() {
		stringstream	ss(line);
		string		f;

		F.clear();
		while(ss >> f) {
			F.push_back(f);
			SKIP_SPACE;
		}
		NF = F.size();
	};

	bool  read_line() {
		F.clear();
		if (getline(cin,line)) {
			split();
			++ NR;
			return true;
		} else {
			return false;
		}
	};

	#define WRL  while(read_line())


	int main(int argc, const char** argv) {
END

#echo -e ' A;\n B; A\n A\n B; A\n {}A\n B({A})\n'|tee /dev/tty|   sed 's/\({[^}]*}\)\{0\}\(\(\((.*)\)\|[^;]\)\+$\)/cout << ( \2 );/'
#echo "$@" | sed 's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 );/' >> $src

case $1 in

	-n)
		shift
		snippet="`echo \"$1\" | sed 's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 ) << endl;/'`"
		echo "
			while ( read_line()) {
				$snippet
			;}
		" >> $src ;;

	-p)
		shift
		snippet="`echo \"$1\" | sed 's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 );/'`"
		echo "
			while (read_line()) {
				$snippet

				for(int i=0;   i < int(F.size())-1;  i++)
					cout  << F[i] << OFS;
				if (F.size() > 0)  cout << F.back();
				cout << endl;
			;}
		" >> $src ;;

	*)  
		snippet="`echo \"$1\" | sed 's/\(.*[;}]\)*\([^;}]\+$\)/\1 cout << ( \2 ) << endl;/'`"
		echo   "$snippet;"  >> $src ;;
			

esac

echo '
} ' 		>>  $src
#cat $src

shift
${CXX-g++} $CXXFLAGS $prg.cc -o $prg $LIBS && $prg "$@"
# vim:set ts=8 sw=8 syntax=sh:   
